<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mythic Realm - Login</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container animated-background">
        <div class="form-box">
            <h1 id="form-title">Login</h1>
            
            <form id="auth-form">
                <input type="email" id="auth-email" placeholder="Email" required>
                <input type="password" id="auth-password" placeholder="Password" required>
                
                <!-- This field is hidden by default -->
                <div id="confirm-pass-container" style="display: none;">
                    <input type="password" id="auth-confirm-password" placeholder="Confirm Password">
                </div>
                
                <button type="submit" class="btn" id="auth-button">Login</button>
            </form>
            
            <p>... or ...</p>
            
            <!-- Google Sign-in Button -->
            <button id="google-signin" class="btn btn-google">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google G Logo" width="20" height="20">
                Sign in with Google
            </button>
            
            <p id="auth-error" class="error-message"></p>

            <p id="toggle-text">Need an account? <a href="#" id="toggle-link">Create one</a></p>

            <!-- NEW: Master Reset Button -->
            <button id="master-reset" class="btn-reset">Admin Reset</button>
        </div>
    </div>
    
    <!-- 
      JavaScript for Firebase Authentication
    -->
    <script type="module">
        // Import functions from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        // NEW: Import Firestore functions for reset
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            deleteDoc 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ▼▼▼ YOUR FIREBASE CONFIG ▼▼▼
        const firebaseConfig = {
          apiKey: "AIzaSyBws0s5YOGs4na5sGZCL9CEgmhuU_YiH2M",
          authDomain: "mythic-realm-game.firebaseapp.com",
          projectId: "mythic-realm-game",
          storageBucket: "mythic-realm-game.firebasestorage.app",
          messagingSenderId: "936485093407",
          appId: "1:936485093407:web:ccd92c30a17152e21d152a"
        };
        // ▲▲▲ YOUR FIREBASE CONFIG ▲▲▲

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); // NEW: Initialize Firestore
        const baseURL = "https://deepmobb.github.io/gameiss/";
        
        // Get elements
        const authForm = document.getElementById('auth-form');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authConfirmPassword = document.getElementById('auth-confirm-password');
        const confirmPassContainer = document.getElementById('confirm-pass-container');
        
        const googleBtn = document.getElementById('google-signin');
        const authError = document.getElementById('auth-error');
        const formTitle = document.getElementById('form-title');
        const authButton = document.getElementById('auth-button');
        const toggleLink = document.getElementById('toggle-link');
        const toggleText = document.getElementById('toggle-text');
        
        const resetButton = document.getElementById('master-reset'); // NEW

        let isLoginMode = true;

        // Toggle between Login and Sign-up
        toggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            authError.textContent = ''; // Clear errors
            
            if (isLoginMode) {
                // Switch to Login Mode
                formTitle.textContent = 'Login';
                authButton.textContent = 'Login';
                toggleText.innerHTML = 'Need an account? <a href="#" id="toggle-link">Create one</a>';
                confirmPassContainer.style.display = 'none';
            } else {
                // Switch to Sign-up Mode
                formTitle.textContent = 'Create Account';
                authButton.textContent = 'Create Account';
                toggleText.innerHTML = 'Have an account? <a href="#" id="toggle-link">Login</a>';
                confirmPassContainer.style.display = 'block';
            }
            // Re-attach listener to the new link
            document.getElementById('toggle-link').addEventListener('click', arguments.callee);
        });

        // Check auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.location.href = baseURL + 'main.html';
            }
        });

        // Handle form submission (Login or Sign-up)
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            authError.textContent = ''; // Clear errors
            
            const email = authEmail.value;
            const password = authPassword.value;

            if (isLoginMode) {
                // --- LOGIN LOGIC ---
                signInWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        window.location.href = baseURL + 'main.html';
                    })
                    .catch((error) => {
                        authError.textContent = error.message;
                    });
            } else {
                // --- SIGN-UP LOGIC ---
                const confirmPassword = authConfirmPassword.value;
                if (password !== confirmPassword) {
                    authError.textContent = "Passwords do not match.";
                    return;
                }
                
                createUserWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        window.location.href = baseURL + 'main.html';
                    })
                    .catch((error) => {
                        authError.textContent = error.message;
                    });
            }
        });

        // Google Sign-in
        googleBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then((result) => {
                    window.location.href = baseURL + 'main.html';
                })
                .catch((error) => {
                    authError.textContent = error.message;
                });
        });

        // --- NEW: Master Reset Function ---
        resetButton.addEventListener('click', () => {
            const pin = prompt("Enter Admin PIN to reset all character data:");
            if (pin === "1909") {
                const confirmReset = confirm("DANGER: This will delete EVERY character from the database. This cannot be undone. Are you absolutely sure?");
                if (confirmReset) {
                    deleteAllCharacters();
                }
            } else if (pin) {
                alert("Incorrect PIN.");
            }
        });

        async function deleteAllCharacters() {
            try {
                const charactersRef = collection(db, "characters");
                const querySnapshot = await getDocs(charactersRef);
                
                if (querySnapshot.empty) {
                    alert("No character data found to delete.");
                    return;
                }

                // Create a batch of delete operations
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                
                // Wait for all deletions to complete
                await Promise.all(deletePromises);
                
                alert(`Success! Deleted ${querySnapshot.size} characters.`);
            } catch (error) {
                console.error("Error deleting characters: ", error);
                alert("An error occurred while deleting characters. Check console.");
            }
        }
    </script>
</body>
</html>

